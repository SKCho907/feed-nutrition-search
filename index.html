<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TS사료 제품 비교</title>
  <style>
    body { font-family:sans-serif; margin:0; padding:16px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
    .controls label { flex:1 1 140px; }
    .controls select { width:100%; padding:8px; font-size:1rem; }
    .table-container { overflow-x:auto; margin-top:24px; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#f4f4f4; }
    #compareChart { width:100%; height:auto; margin-top:24px; }
    .hidden { display:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1 style="text-align:center;">사료 제품 비교</h1>

  <div class="controls">
    <!-- 비교 제품1용 축종 선택 -->
    <label>비교 제품 1 축종:
      <select id="speciesSelect">
        <option value="">-- 축종 선택 --</option>
        <option value="낙농">낙농</option>
        <option value="비육">비육</option>
        <option value="양돈">양돈</option>
      </select>
    </label>

    <!-- 비교 제품1 -->
    <label>비교 제품 1:
      <select id="comp1Select" disabled>
        <option value="">-- 먼저 축종 선택 --</option>
      </select>
    </label>

    <!-- 비교 제품2용 축종 선택 (comp1 선택 후 활성화) -->
    <label>비교 제품 2 축종:
      <select id="species2Select" disabled>
        <option value="">-- 비교 1 선택 후 --</option>
      </select>
    </label>

    <!-- 비교 제품2 -->
    <label>비교 제품 2:
      <select id="comp2Select" disabled>
        <option value="">-- 먼저 축종 선택 --</option>
      </select>
    </label>
  </div>

  <div class="table-container">
    <table id="compareTable" class="hidden">
      <thead>
        <tr>
          <th>항목</th>
          <th id="hdr1">제품1</th>
          <th id="hdr2">제품2</th>
          <th>차이</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="compareChart" class="hidden"></canvas>
  </div>

  <script type="module">
    import products from './products.js';

    const speciesSelect  = document.getElementById('speciesSelect');
    const comp1Select    = document.getElementById('comp1Select');
    const species2Select = document.getElementById('species2Select');
    const comp2Select    = document.getElementById('comp2Select');
    const compareTable   = document.getElementById('compareTable');
    const compareBody    = compareTable.querySelector('tbody');
    const hdr1           = document.getElementById('hdr1');
    const hdr2           = document.getElementById('hdr2');
    const chartCanvas    = document.getElementById('compareChart');
    let compareChart     = null;

    // 드롭다운 옵션 채워주는 헬퍼
    function populate(selectEl, list) {
      selectEl.innerHTML =
        '<option value="">-- 제품 선택 --</option>' +
        list.map(p => `<option value="${p.No}">${p.제품명}</option>`).join('');
    }

    // 1) 비교1 축종 선택 → comp1Select 활성화 & 옵션 채우기
    speciesSelect.addEventListener('change', () => {
      const sp = speciesSelect.value;
      if (!sp) {
        comp1Select.disabled = true;
        comp1Select.innerHTML = '<option>-- 먼저 축종 선택 --</option>';
        // comp2 단계 초기화
        species2Select.disabled = true;
        comp2Select.disabled    = true;
      } else {
        const list = products.filter(p => p.축종 === sp)
                             .sort((a,b) => a.제품명.localeCompare(b.제품명,'ko'));
        populate(comp1Select, list);
        comp1Select.disabled = false;
        // comp2 단계 초기화
        species2Select.disabled = true;
        comp2Select.disabled    = true;
        species2Select.innerHTML = '<option>-- 비교 1 선택 후 --</option>';
        comp2Select.innerHTML    = '<option>-- 먼저 축종 선택 --</option>';
      }
      // 테이블·차트 초기화
      compareTable.classList.add('hidden');
      chartCanvas.classList.add('hidden');
      if (compareChart) { compareChart.destroy(); compareChart = null; }
    });

    // 2) comp1 선택 → species2Select 활성화
    comp1Select.addEventListener('change', () => {
      if (!comp1Select.value) {
        species2Select.disabled = true;
      } else {
        species2Select.disabled = false;
        // 두번째 축종 드롭다운은 동일하게 세 축종 중 골라주면 됩니다
        species2Select.innerHTML = `
          <option value="">-- 축종 선택 --</option>
          <option value="낙농">낙농</option>
          <option value="비육">비육</option>
          <option value="양돈">양돈</option>
        `;
        comp2Select.disabled = true;
        comp2Select.innerHTML = '<option>-- 비교 2 축종 후 --</option>';
      }
      // 초기화
      compareTable.classList.add('hidden');
      chartCanvas.classList.add('hidden');
      if (compareChart) { compareChart.destroy(); compareChart = null; }
    });

    // 3) 비교2 축종 선택 → comp2Select 활성화 & 옵션 채우기
    species2Select.addEventListener('change', () => {
      const sp2 = species2Select.value;
      if (!sp2) {
        comp2Select.disabled = true;
        comp2Select.innerHTML = '<option>-- 먼저 축종 선택 --</option>';
      } else {
        const list2 = products.filter(p => p.축종 === sp2)
                              .sort((a,b) => a.제품명.localeCompare(b.제품명,'ko'));
        populate(comp2Select, list2);
        comp2Select.disabled = false;
      }
      // 초기화
      compareTable.classList.add('hidden');
      chartCanvas.classList.add('hidden');
      if (compareChart) { compareChart.destroy(); compareChart = null; }
    });

    // 비교 테이블 + 차트 렌더러
    function renderCompare(n1, n2) {
      const p1 = products.find(x => x.No === n1);
      const p2 = products.find(x => x.No === n2);
      if (!p1 || !p2) return;
      hdr1.textContent = p1.제품명;
      hdr2.textContent = p2.제품명;
      compareBody.innerHTML = '';
      const labels = [], d1 = [], d2 = [];
      Object.keys(p1).filter(k=>!['No','제품명','축종'].includes(k)).forEach(key => {
        const v1 = p1[key], v2 = p2[key];
        compareBody.insertAdjacentHTML('beforeend',
          `<tr>
             <td>${key}</td>
             <td>${v1!==undefined?v1:''}</td>
             <td>${v2!==undefined?v2:''}</td>
             <td>${(typeof v1==='number'&&typeof v2==='number')?
               (v1-v2).toFixed(2):''}</td>
           </tr>`
        );
        if (typeof v1==='number'&&typeof v2==='number') {
          labels.push(key);
          d1.push(v1);
          d2.push(v2);
        }
      });
      compareTable.classList.remove('hidden');
      chartCanvas.classList.remove('hidden');
      if (compareChart) compareChart.destroy();
      compareChart = new Chart(chartCanvas.getContext('2d'), {
        type:'bar',
        data:{ labels, datasets:[
          { label:p1.제품명, data:d1 },
          { label:p2.제품명, data:d2 }
        ]},
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // 최종 바인딩
    comp2Select.addEventListener('change', () =>
      renderCompare(
        Number(comp1Select.value),
        Number(comp2Select.value)
      )
    );
  </script>
</body>
</html>
